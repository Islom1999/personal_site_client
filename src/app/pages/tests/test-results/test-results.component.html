<ng-template pTemplate="header">
  <div class="flex items-center justify-between w-full">
    <h3 class="text-2xl font-bold text-gray-900">Test Natijalari</h3>
    <div class="flex items-center space-x-4">
      <span class="px-3 py-1 bg-blue-100 text-blue-800 text-sm font-medium rounded-full">
        {{ currentResult?.testTitle }}
      </span>
    </div>
  </div>
</ng-template>

<div class="h-full overflow-auto" *ngIf="currentResult">
  <p-tabs value="overview" class="h-full">
    <p-tablist>
      <p-tab value="overview">
        <i class="pi pi-chart-pie mr-2"></i>
        Umumiy natija
      </p-tab>
      <p-tab value="detailed">
        <i class="pi pi-list mr-2"></i>
        Batafsil ko'rib chiqish
      </p-tab>
      <p-tab value="history">
        <i class="pi pi-history mr-2"></i>
        Natijalar tarixi
      </p-tab>
    </p-tablist>
    <p-tabpanels>
      <!-- Results Overview -->
      <p-tabpanel value="overview">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
          <!-- Score Summary -->
          <div class="space-y-6">
            <!-- Main Score -->
            <div class="text-center bg-gradient-to-br from-blue-50 to-indigo-50 rounded-2xl p-8">
              <div class="text-6xl font-bold text-blue-600 mb-2">{{ currentResult.score }}%</div>
              <div class="text-xl text-gray-700 mb-4">Umumiy natija</div>
              <div class="text-gray-600">
                {{ currentResult.correctAnswers }} / {{ currentResult.totalQuestions }} to'g'ri
                javob
              </div>
            </div>

            <!-- Performance Metrics -->
            <div class="grid grid-cols-2 gap-4">
              <div class="bg-white rounded-xl p-6 shadow-lg text-center">
                <div
                  class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center mx-auto mb-3"
                >
                  <i class="pi pi-check text-green-600 text-xl"></i>
                </div>
                <div class="text-2xl font-bold text-gray-900 mb-1">
                  {{ currentResult.correctAnswers }}
                </div>
                <div class="text-gray-600 text-sm">To'g'ri javoblar</div>
              </div>
              <div class="bg-white rounded-xl p-6 shadow-lg text-center">
                <div
                  class="w-12 h-12 bg-red-100 rounded-xl flex items-center justify-center mx-auto mb-3"
                >
                  <i class="pi pi-times text-red-600 text-xl"></i>
                </div>
                <div class="text-2xl font-bold text-gray-900 mb-1">
                  {{ currentResult.totalQuestions - currentResult.correctAnswers }}
                </div>
                <div class="text-gray-600 text-sm">Noto'g'ri javoblar</div>
              </div>
              <div class="bg-white rounded-xl p-6 shadow-lg text-center">
                <div
                  class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center mx-auto mb-3"
                >
                  <i class="pi pi-clock text-blue-600 text-xl"></i>
                </div>
                <div class="text-2xl font-bold text-gray-900 mb-1">
                  {{ currentResult.timeSpent }}
                </div>
                <div class="text-gray-600 text-sm">Daqiqa</div>
              </div>
              <div class="bg-white rounded-xl p-6 shadow-lg text-center">
                <div
                  class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center mx-auto mb-3"
                >
                  <i class="pi pi-calendar text-purple-600 text-xl"></i>
                </div>
                <div class="text-2xl font-bold text-gray-900 mb-1">
                  {{ formatDate(currentResult.date) }}
                </div>
                <div class="text-gray-600 text-sm">Test sanasi</div>
              </div>
            </div>

            <!-- Performance Level -->
            <div class="bg-white rounded-xl p-6 shadow-lg">
              <h4 class="text-lg font-semibold text-gray-900 mb-4">Baholash</h4>
              <div class="space-y-3">
                <div class="flex items-center justify-between">
                  <span class="text-gray-600">Daraja:</span>
                  <span [class]="getPerformanceClass(currentResult.score)" class="font-semibold">
                    {{ getPerformanceLevel(currentResult.score) }}
                  </span>
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-gray-600">Baho:</span>
                  <span [class]="getGradeClass(currentResult.score)" class="font-semibold text-lg">
                    {{ getGrade(currentResult.score) }}
                  </span>
                </div>
              </div>
            </div>
          </div>

          <!-- Chart -->
          <div class="space-y-6">
            <!-- Score Chart -->
            <div class="bg-white rounded-xl p-6 shadow-lg">
              <h4 class="text-lg font-semibold text-gray-900 mb-4">Natijalar taqsimoti</h4>
              <p-chart
                type="doughnut"
                [data]="chartData"
                [options]="chartOptions"
                class="w-full h-64"
              >
              </p-chart>
            </div>

            <!-- Category Performance -->
            <div class="bg-white rounded-xl p-6 shadow-lg">
              <h4 class="text-lg font-semibold text-gray-900 mb-4">Mavzular bo'yicha natija</h4>
              <div class="space-y-3">
                @for (category of categories(); track category.id) {
                <div class="flex items-center justify-between">
                  <span class="text-gray-600">{{ category.name }}:</span>
                  <!-- <div class="flex items-center space-x-2">
                          <p-progressBar [value]="category.score" class="w-20 h-2"></p-progressBar>
                          <span class="font-semibold text-sm w-12">{{ category.score }}%</span>
                        </div> -->
                </div>
                }
              </div>
            </div>

            <!-- Recommendations -->
            <div class="bg-gradient-to-br from-yellow-50 to-orange-50 rounded-xl p-6">
              <h4 class="text-lg font-semibold text-gray-900 mb-4">
                <i class="pi pi-lightbulb text-yellow-600 mr-2"></i>
                Tavsiyalar
              </h4>
              <ul class="space-y-2 text-gray-700">
                <li
                  *ngFor="let recommendation of getRecommendations(currentResult.score)"
                  class="flex items-start"
                >
                  <i class="pi pi-arrow-right text-yellow-600 mr-2 mt-1"></i>
                  {{ recommendation }}
                </li>
              </ul>
            </div>
          </div>
        </div>
      </p-tabpanel>

      <!-- Detailed Review -->
      <p-tabpanel value="detailed">
        <div class="max-w-4xl mx-auto">
          <div class="space-y-6">
            <div
              *ngFor="let question of currentResult.questions; let i = index"
              class="bg-white rounded-xl p-6 shadow-lg border-l-4"
              [class.border-green-500]="currentResult.answers[i] === question.correctAnswer"
              [class.border-red-500]="
                currentResult.answers[i] !== question.correctAnswer &&
                currentResult.answers[i] !== null
              "
              [class.border-gray-300]="currentResult.answers[i] === null"
            >
              <!-- Question Header -->
              <div class="flex items-center justify-between mb-4">
                <h4 class="text-lg font-semibold text-gray-900">Savol {{ i + 1 }}</h4>
                <div class="flex items-center space-x-2">
                  <span
                    *ngIf="currentResult.answers[i] === question.correctAnswer"
                    class="px-2 py-1 bg-green-100 text-green-800 text-xs font-medium rounded-full"
                  >
                    <i class="pi pi-check mr-1"></i>To'g'ri
                  </span>
                  <span
                    *ngIf="
                      currentResult.answers[i] !== question.correctAnswer &&
                      currentResult.answers[i] !== null
                    "
                    class="px-2 py-1 bg-red-100 text-red-800 text-xs font-medium rounded-full"
                  >
                    <i class="pi pi-times mr-1"></i>Noto'g'ri
                  </span>
                  <span
                    *ngIf="currentResult.answers[i] === null"
                    class="px-2 py-1 bg-gray-100 text-gray-800 text-xs font-medium rounded-full"
                  >
                    <i class="pi pi-minus mr-1"></i>Javobsiz
                  </span>
                </div>
              </div>

              <!-- Question Text -->
              <p class="text-gray-800 mb-4 font-medium">{{ question.question }}</p>

              <!-- Options -->
              <div class="space-y-2 mb-4">
                <div
                  *ngFor="let option of question.options; let j = index"
                  class="flex items-center p-3 rounded-lg border"
                  [class.bg-green-50]="j === question.correctAnswer"
                  [class.border-green-300]="j === question.correctAnswer"
                  [class.bg-red-50]="j === currentResult.answers[i] && j !== question.correctAnswer"
                  [class.border-red-300]="
                    j === currentResult.answers[i] && j !== question.correctAnswer
                  "
                  [class.bg-gray-50]="
                    j !== question.correctAnswer && j !== currentResult.answers[i]
                  "
                  [class.border-gray-200]="
                    j !== question.correctAnswer && j !== currentResult.answers[i]
                  "
                >
                  <div class="flex items-center space-x-3">
                    <div
                      class="w-6 h-6 rounded-full border-2 flex items-center justify-center"
                      [class.bg-green-500]="j === question.correctAnswer"
                      [class.border-green-500]="j === question.correctAnswer"
                      [class.bg-red-500]="
                        j === currentResult.answers[i] && j !== question.correctAnswer
                      "
                      [class.border-red-500]="
                        j === currentResult.answers[i] && j !== question.correctAnswer
                      "
                      [class.border-gray-300]="
                        j !== question.correctAnswer && j !== currentResult.answers[i]
                      "
                    >
                      <i
                        *ngIf="j === question.correctAnswer"
                        class="pi pi-check text-white text-xs"
                      ></i>
                      <i
                        *ngIf="j === currentResult.answers[i] && j !== question.correctAnswer"
                        class="pi pi-times text-white text-xs"
                      ></i>
                    </div>
                    <span
                      class="flex-1"
                      [class.text-green-800]="j === question.correctAnswer"
                      [class.font-semibold]="j === question.correctAnswer"
                      [class.text-red-800]="
                        j === currentResult.answers[i] && j !== question.correctAnswer
                      "
                    >
                      {{ option }}
                    </span>
                  </div>
                </div>
              </div>

              <!-- Explanation -->
              <div *ngIf="question.explanation" class="bg-blue-50 rounded-lg p-4">
                <h5 class="font-semibold text-blue-900 mb-2">
                  <i class="pi pi-info-circle mr-2"></i>Tushuntirish:
                </h5>
                <p class="text-blue-800">{{ question.explanation }}</p>
              </div>
            </div>
          </div>
        </div>
      </p-tabpanel>

      <!-- Performance History -->
      <p-tabpanel value="history">
        <div class="max-w-4xl mx-auto">
          <div class="bg-white rounded-xl p-6 shadow-lg mb-6">
            <h4 class="text-lg font-semibold text-gray-900 mb-4">Test natijalari dinamikasi</h4>
            <p-chart
              type="line"
              [data]="historyChartData"
              [options]="historyChartOptions"
              class="w-full h-64"
            >
            </p-chart>
          </div>

          <div class="space-y-4">
            <h4 class="text-lg font-semibold text-gray-900">Barcha urinishlar</h4>
            <div
              *ngFor="let result of testHistory"
              class="bg-white rounded-xl p-6 shadow-lg flex items-center justify-between"
            >
              <div class="flex items-center space-x-4">
                <div
                  class="w-12 h-12 rounded-xl flex items-center justify-center"
                  [class.bg-green-100]="result.score >= 80"
                  [class.bg-yellow-100]="result.score >= 60 && result.score < 80"
                  [class.bg-red-100]="result.score < 60"
                >
                  <span
                    class="font-bold"
                    [class.text-green-600]="result.score >= 80"
                    [class.text-yellow-600]="result.score >= 60 && result.score < 80"
                    [class.text-red-600]="result.score < 60"
                  >
                    {{ result.score }}%
                  </span>
                </div>
                <div>
                  <h5 class="font-semibold text-gray-900">{{ result.testTitle }}</h5>
                  <p class="text-gray-600 text-sm">
                    {{ result.correctAnswers }}/{{ result.totalQuestions }} to'g'ri •
                    {{ result.timeSpent }} daqiqa •
                    {{ formatDate(result.date) }}
                  </p>
                </div>
              </div>
              <div class="flex items-center space-x-2">
                <p-button
                  icon="pi pi-eye"
                  [text]="true"
                  [rounded]="true"
                  class="text-blue-600 hover:bg-blue-50"
                  (onClick)="viewDetailedResult(result)"
                  pTooltip="Batafsil ko'rish"
                >
                </p-button>
              </div>
            </div>
          </div>
        </div>
      </p-tabpanel>
    </p-tabpanels>
  </p-tabs>
</div>
